import { useState, useEffect } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { useNavigate } from "react-router-dom";
import { Card, Flex, Text, TextField, Select, TextArea, Box, Checkbox } from "@radix-ui/themes";
import { Loader2 } from "lucide-react";
import { viabilidadSchema, ViabilidadFormValues } from "@/lib/validations/viabilidad";
import { useCreateViabilidad } from "@/hooks/useViabilidades";
import { useTipoEnlaces } from "@/hooks/useTipoEnlace";
import { useEmpresas } from "@/hooks/useEmpresas";
import { useAreasDesarrollo } from "@/hooks/useAreasDesarrollo";
import { useListaUbicaciones } from "@/hooks/useListaUbicaciones";
import { useModulos } from "@/hooks/useModulos";
import { useRutasUbicacion } from "@/hooks/useRutasUbicacion";
import { useTipoConexions } from "@/hooks/useTipoConexion";
import { GoogleMapPicker } from "@/components/GoogleMapPicker";
import {
  Wizard,
  WizardSteps,
  WizardStep,
  WizardNavigation,
  WizardActions,
  useWizard,
} from "@/components/ui/Wizard";
import { toast } from "sonner";

const WIZARD_STEPS = [
  { id: 1, title: "Tipo de Enlace", subtitle: "Paso 1" },
  { id: 2, title: "Punto A", subtitle: "Paso 2" },
  { id: 3, title: "Punto Z", subtitle: "Paso 3" },
  { id: 4, title: "Ruta y Conexión", subtitle: "Paso 4" },
];

export function ViabilidadWizardEnterprise() {
  return (
    <Box style={{ maxWidth: "1200px", margin: "0 auto", padding: "2rem" }}>
      <Card size="4">
        <Wizard>
          <WizardContent />
        </Wizard>
      </Card>
    </Box>
  );
}

function WizardContent() {
  const { currentStep, nextStep, markStepComplete, markStepIncomplete } = useWizard();
  const [usarMapaA, setUsarMapaA] = useState(false);
  const [usarMapaZ, setUsarMapaZ] = useState(false);
  const [usarInquilino, setUsarInquilino] = useState(false);
  const [inquilino, setInquilino] = useState("");
  const navigate = useNavigate();
  const createViabilidad = useCreateViabilidad();

  // Fetch catalogs
  const { data: tipoEnlacesData, isLoading: loadingTipoEnlaces } = useTipoEnlaces({});
  const { data: empresasData, isLoading: loadingEmpresas } = useEmpresas({});
  const { data: areasDesarrolloData, isLoading: loadingAreasDesarrollo } = useAreasDesarrollo({});

  const tipoEnlaces = tipoEnlacesData?.data || [];
  const empresas = empresasData?.data || [];
  const areasDesarrollo = areasDesarrolloData?.data || [];

  const {
    register,
    handleSubmit,
    formState: { errors },
    watch,
    setValue,
    trigger,
  } = useForm<ViabilidadFormValues>({
    resolver: zodResolver(viabilidadSchema),
    mode: "onChange",
    defaultValues: {
      isEspecial: false,
      ID_ProcesoViabilidad: 1,
      ID_Proceso: 1,
      ClasificacionViabilidad_Id: 1,
      ContactoComercialId: 1,
      ContactoTecnicoId: 1,
      elementoaId: 1,
      elementozId: 1,
      UbicacionaId: 1,
      UbicacionzId: 1,
      ID_RutaUbicacion: 1,
      document_number: `VIAB-${Date.now()}`,
    },
  });

  // Watch for selected values
  const selectedTipoEnlace = watch("ID_TipoEnlace");
  const selectedEmpresa = watch("EmpresaId");
  const selectedAreaA = watch("adesarrolloaid");
  const selectedAreaZ = watch("adesarrollozid");
  const selectedUbicacionA = watch("listaUbicacionesaId");
  const selectedUbicacionZ = watch("listaUbicacioneszId");
  const selectedModuloA = watch("moduloaId");
  const selectedModuloZ = watch("modulozId");
  const selectedRuta = watch("ID_RutaUbicacion");
  const selectedTipoConexion = watch("ID_TipoConexion");

  // Fetch ubicaciones filtered by area
  const { data: ubicacionesAData, isLoading: loadingUbicacionesA } = useListaUbicaciones({
    idAreaDesarrollo: selectedAreaA || undefined,
  });
  const { data: ubicacionesZData, isLoading: loadingUbicacionesZ } = useListaUbicaciones({
    idAreaDesarrollo: selectedAreaZ || undefined,
  });

  // Fetch módulos filtered by ubicación
  const { data: modulosAData, isLoading: loadingModulosA } = useModulos({
    idListaUbicaciones: selectedUbicacionA || undefined,
    estado: true,
  });
  const { data: modulosZData, isLoading: loadingModulosZ } = useModulos({
    idListaUbicaciones: selectedUbicacionZ || undefined,
    estado: true,
  });

  const ubicacionesA = ubicacionesAData?.data || [];
  const ubicacionesZ = ubicacionesZData?.data || [];
  const modulosA = modulosAData?.data || [];
  const modulosZ = modulosZData?.data || [];

  // Fetch rutas filtered by Lista Ubicación Z
  const { data: rutasData, isLoading: loadingRutas } = useRutasUbicacion({
    idListaUbicacion: selectedUbicacionZ || undefined,
  });

  const rutas = rutasData?.data || [];

  // Fetch tipos de conexión
  const { data: tipoConexionData, isLoading: loadingTipoConexion } = useTipoConexions({});
  const tiposConexion = tipoConexionData?.data || [];

  // Reset cascading dropdowns
  useEffect(() => {
    if (selectedAreaA) {
      setValue("listaUbicacionesaId", 0);
      setValue("moduloaId", 0);
    }
  }, [selectedAreaA, setValue]);

  useEffect(() => {
    if (selectedAreaZ) {
      setValue("listaUbicacioneszId", 0);
      setValue("modulozId", 0);
    }
  }, [selectedAreaZ, setValue]);

  useEffect(() => {
    if (selectedUbicacionA) {
      setValue("moduloaId", 0);
    }
  }, [selectedUbicacionA, setValue]);

  useEffect(() => {
    if (selectedUbicacionZ) {
      setValue("modulozId", 0);
    }
  }, [selectedUbicacionZ, setValue]);

  // Update coordinates and inquilino when módulo changes
  useEffect(() => {
    if (selectedModuloA && modulosA.length > 0) {
      const modulo = modulosA.find((m: any) => m.id === selectedModuloA);
      if (modulo) {
        setValue("CoordenadasA", modulo.Coordenadas || "");
        if (modulo.Inquilino) {
          setInquilino(modulo.Inquilino);
        }
      }
    }
  }, [selectedModuloA, modulosA, setValue]);

  useEffect(() => {
    if (selectedModuloZ && modulosZ.length > 0) {
      const modulo = modulosZ.find((m: any) => m.id === selectedModuloZ);
      if (modulo) {
        setValue("CoordenadasZ", modulo.Coordenadas || "");
        if (modulo.Inquilino) {
          setInquilino(modulo.Inquilino);
        }
      }
    }
  }, [selectedModuloZ, modulosZ, setValue]);

  // Handle inquilino checkbox
  useEffect(() => {
    if (usarInquilino) {
      setValue("Cliente_FinalA", inquilino);
    } else {
      setValue("Cliente_FinalA", "");
    }
  }, [usarInquilino, inquilino, setValue]);

  // Auto-update NRC/MRC when ruta changes
  useEffect(() => {
    if (selectedRuta && rutas.length > 0) {
      const ruta = rutas.find((r: any) => r.id === selectedRuta);
      if (ruta) {
        setValue("NRC", ruta.NRC?.toString() || "");
        setValue("MRC", ruta.MRC?.toString() || "");
      }
    }
  }, [selectedRuta, rutas, setValue]);

  const handleMapCoordinatesA = (lat: number, lng: number) => {
    setValue("CoordenadasA", `${lat} , ${lng}`);
  };

  const handleMapCoordinatesZ = (lat: number, lng: number) => {
    setValue("CoordenadasZ", `${lat} , ${lng}`);
  };

  const validateCurrentStep = async () => {
    let fieldsToValidate: (keyof ViabilidadFormValues)[] = [];

    switch (currentStep) {
      case 0: // Paso 1
        fieldsToValidate = ["ID_TipoEnlace", "EmpresaId", "Detalles_Viabilidad"];
        break;
      case 1: // Paso 2
        fieldsToValidate = [
          "adesarrolloaid",
          "listaUbicacionesaId",
          "moduloaId",
          "CoordenadasA",
          "Cliente_FinalA",
        ];
        break;
      case 2: // Paso 3
        fieldsToValidate = [
          "adesarrollozid",
          "listaUbicacioneszId",
          "modulozId",
          "CoordenadasZ",
        ];
        break;
      case 3: // Paso 4
        fieldsToValidate = ["ID_RutaUbicacion", "ID_TipoConexion", "NRC", "MRC"];
        break;
    }

    const result = await trigger(fieldsToValidate);
    if (result) {
      markStepComplete(currentStep);
    } else {
      markStepIncomplete(currentStep);
    }
    return result;
  };

  const handleNext = async () => {
    const isValid = await validateCurrentStep();
    if (isValid) {
      nextStep();
    } else {
      toast.error("Por favor complete todos los campos requeridos");
    }
  };

  const onSubmit = async (data: ViabilidadFormValues) => {
    try {
      await createViabilidad.mutateAsync(data);
      toast.success("Viabilidad creada exitosamente");
      navigate("/viabilidades");
    } catch (error: any) {
      toast.error(error.message || "Error al crear viabilidad");
    }
  };

  return (
    <>
      <WizardNavigation steps={WIZARD_STEPS} />

      <form onSubmit={handleSubmit(onSubmit)}>
        <WizardSteps>
          {/* PASO 1: Tipo de Enlace */}
          <WizardStep title="Información General" description="Seleccione el tipo de enlace y empresa">
            <Flex direction="column" gap="4">
              <Box>
                <Text as="label" size="2" weight="medium" mb="2">
                  Tipo de Enlace *
                </Text>
                <Select.Root
                  value={selectedTipoEnlace?.toString() || ""}
                  onValueChange={(value) => setValue("ID_TipoEnlace", parseInt(value), { shouldValidate: true })}
                >
                  <Select.Trigger
                    placeholder="Seleccione tipo de enlace"
                    style={{ width: "100%" }}
                  />
                  <Select.Content>
                    {loadingTipoEnlaces ? (
                      <Select.Item value="0" disabled>
                        <Loader2 className="animate-spin" size={16} />
                        Cargando...
                      </Select.Item>
                    ) : (
                      tipoEnlaces.map((tipo: any) => (
                        <Select.Item key={tipo.id} value={tipo.id.toString()}>
                          {tipo.Nombre}
                        </Select.Item>
                      ))
                    )}
                  </Select.Content>
                </Select.Root>
                {errors.ID_TipoEnlace && (
                  <Text size="1" color="red" mt="1">
                    {errors.ID_TipoEnlace.message}
                  </Text>
                )}
              </Box>

              <Box>
                <Text as="label" size="2" weight="medium" mb="2">
                  Empresa *
                </Text>
                <Select.Root
                  value={selectedEmpresa?.toString() || ""}
                  onValueChange={(value) => setValue("EmpresaId", parseInt(value), { shouldValidate: true })}
                >
                  <Select.Trigger placeholder="Seleccione empresa" style={{ width: "100%" }} />
                  <Select.Content>
                    {loadingEmpresas ? (
                      <Select.Item value="0" disabled>
                        <Loader2 className="animate-spin" size={16} />
                        Cargando...
                      </Select.Item>
                    ) : (
                      empresas.map((empresa: any) => (
                        <Select.Item key={empresa.id} value={empresa.id.toString()}>
                          {empresa.Nombre_Empresa}
                        </Select.Item>
                      ))
                    )}
                  </Select.Content>
                </Select.Root>
                {errors.EmpresaId && (
                  <Text size="1" color="red" mt="1">
                    {errors.EmpresaId.message}
                  </Text>
                )}
              </Box>

              <Box>
                <Text as="label" size="2" weight="medium" mb="2">
                  Detalles de Viabilidad *
                </Text>
                <TextArea
                  {...register("Detalles_Viabilidad")}
                  placeholder="Ingrese los detalles de la viabilidad"
                  rows={4}
                />
                {errors.Detalles_Viabilidad && (
                  <Text size="1" color="red" mt="1">
                    {errors.Detalles_Viabilidad.message}
                  </Text>
                )}
              </Box>
            </Flex>
          </WizardStep>

          {/* PASO 2: Punto A */}
          <WizardStep title="Detalle de Interconexión A" description="Información del punto de origen">
            <Flex direction="column" gap="4">
              <Flex gap="4">
                <Box style={{ flex: 1 }}>
                  <Text as="label" size="2" weight="medium" mb="2">
                    Área de Desarrollo A *
                  </Text>
                  <Select.Root
                    {...register("adesarrolloaid", { valueAsNumber: true })}
                    onValueChange={(value) => setValue("adesarrolloaid", parseInt(value))}
                  >
                    <Select.Trigger
                      placeholder="Seleccione área"
                      style={{ width: "100%" }}
                    />
                    <Select.Content>
                      {loadingAreasDesarrollo ? (
                        <Select.Item value="0" disabled>
                          <Loader2 className="animate-spin" size={16} />
                          Cargando...
                        </Select.Item>
                      ) : (
                        areasDesarrollo.map((area: any) => (
                          <Select.Item key={area.id} value={area.id.toString()}>
                            {area.Nombre_AreaDesarrollo}
                          </Select.Item>
                        ))
                      )}
                    </Select.Content>
                  </Select.Root>
                  {errors.adesarrolloaid && (
                    <Text size="1" color="red" mt="1">
                      {errors.adesarrolloaid.message}
                    </Text>
                  )}
                </Box>

                <Box style={{ flex: 1 }}>
                  <Text as="label" size="2" weight="medium" mb="2">
                    Ubicación A *
                  </Text>
                  <Select.Root
                    {...register("listaUbicacionesaId", { valueAsNumber: true })}
                    onValueChange={(value) => setValue("listaUbicacionesaId", parseInt(value))}
                    disabled={!selectedAreaA}
                  >
                    <Select.Trigger
                      placeholder="Seleccione ubicación"
                      style={{ width: "100%" }}
                    />
                    <Select.Content>
                      {loadingUbicacionesA ? (
                        <Select.Item value="0" disabled>
                          <Loader2 className="animate-spin" size={16} />
                          Cargando...
                        </Select.Item>
                      ) : ubicacionesA.length === 0 ? (
                        <Select.Item value="0" disabled>
                          No hay ubicaciones disponibles
                        </Select.Item>
                      ) : (
                        ubicacionesA.map((ubicacion: any) => (
                          <Select.Item key={ubicacion.id} value={ubicacion.id.toString()}>
                            {ubicacion.Nombre_Ubicacion}
                          </Select.Item>
                        ))
                      )}
                    </Select.Content>
                  </Select.Root>
                  {errors.listaUbicacionesaId && (
                    <Text size="1" color="red" mt="1">
                      {errors.listaUbicacionesaId.message}
                    </Text>
                  )}
                </Box>
              </Flex>

              <Box>
                <Text as="label" size="2" weight="medium" mb="2">
                  Módulo A *
                </Text>
                <Select.Root
                  {...register("moduloaId", { valueAsNumber: true })}
                  onValueChange={(value) => setValue("moduloaId", parseInt(value))}
                  disabled={!selectedUbicacionA}
                >
                  <Select.Trigger placeholder="Seleccione módulo" style={{ width: "100%" }} />
                  <Select.Content>
                    {loadingModulosA ? (
                      <Select.Item value="0" disabled>
                        <Loader2 className="animate-spin" size={16} />
                        Cargando...
                      </Select.Item>
                    ) : modulosA.length === 0 ? (
                      <Select.Item value="0" disabled>
                        No hay módulos disponibles
                      </Select.Item>
                    ) : (
                      modulosA.map((modulo: any) => (
                        <Select.Item key={modulo.id} value={modulo.id.toString()}>
                          {modulo.Nombre}
                        </Select.Item>
                      ))
                    )}
                  </Select.Content>
                </Select.Root>
                {errors.moduloaId && (
                  <Text size="1" color="red" mt="1">
                    {errors.moduloaId.message}
                  </Text>
                )}
              </Box>

              <Box>
                <Flex align="center" gap="2" mb="2">
                  <Checkbox
                    checked={usarMapaA}
                    onCheckedChange={(checked) => setUsarMapaA(checked === true)}
                  />
                  <Text size="2" weight="medium">
                    Usar Mapa para Establecer Coordenadas
                  </Text>
                </Flex>

                {usarMapaA && (
                  <Box mb="3">
                    <GoogleMapPicker onCoordinatesChange={handleMapCoordinatesA} />
                  </Box>
                )}

                <Text as="label" size="2" weight="medium" mb="2">
                  Coordenadas A *
                </Text>
                <TextField.Root
                  {...register("CoordenadasA")}
                  placeholder="Ejemplo: 8.9138353 , -79.6087425"
                />
                {errors.CoordenadasA && (
                  <Text size="1" color="red" mt="1">
                    {errors.CoordenadasA.message}
                  </Text>
                )}
              </Box>

              <Box>
                <Text as="label" size="2" weight="medium" mb="2">
                  Cliente Final A *
                </Text>
                <TextField.Root
                  {...register("Cliente_FinalA")}
                  placeholder="Ingrese cliente final"
                  value={usarInquilino ? inquilino : undefined}
                />
                {errors.Cliente_FinalA && (
                  <Text size="1" color="red" mt="1">
                    {errors.Cliente_FinalA.message}
                  </Text>
                )}
              </Box>
            </Flex>
          </WizardStep>

          {/* PASO 3: Punto Z */}
          <WizardStep title="Detalle de Interconexión Z" description="Información del punto de destino">
            <Flex direction="column" gap="4">
              <Flex gap="4">
                <Box style={{ flex: 1 }}>
                  <Text as="label" size="2" weight="medium" mb="2">
                    Área de Desarrollo Z *
                  </Text>
                  <Select.Root
                    {...register("adesarrollozid", { valueAsNumber: true })}
                    onValueChange={(value) => setValue("adesarrollozid", parseInt(value))}
                  >
                    <Select.Trigger
                      placeholder="Seleccione área"
                      style={{ width: "100%" }}
                    />
                    <Select.Content>
                      {loadingAreasDesarrollo ? (
                        <Select.Item value="0" disabled>
                          <Loader2 className="animate-spin" size={16} />
                          Cargando...
                        </Select.Item>
                      ) : (
                        areasDesarrollo.map((area: any) => (
                          <Select.Item key={area.id} value={area.id.toString()}>
                            {area.Nombre_AreaDesarrollo}
                          </Select.Item>
                        ))
                      )}
                    </Select.Content>
                  </Select.Root>
                  {errors.adesarrollozid && (
                    <Text size="1" color="red" mt="1">
                      {errors.adesarrollozid.message}
                    </Text>
                  )}
                </Box>

                <Box style={{ flex: 1 }}>
                  <Text as="label" size="2" weight="medium" mb="2">
                    Ubicación Z *
                  </Text>
                  <Select.Root
                    {...register("listaUbicacioneszId", { valueAsNumber: true })}
                    onValueChange={(value) => setValue("listaUbicacioneszId", parseInt(value))}
                    disabled={!selectedAreaZ}
                  >
                    <Select.Trigger
                      placeholder="Seleccione ubicación"
                      style={{ width: "100%" }}
                    />
                    <Select.Content>
                      {loadingUbicacionesZ ? (
                        <Select.Item value="0" disabled>
                          <Loader2 className="animate-spin" size={16} />
                          Cargando...
                        </Select.Item>
                      ) : ubicacionesZ.length === 0 ? (
                        <Select.Item value="0" disabled>
                          No hay ubicaciones disponibles
                        </Select.Item>
                      ) : (
                        ubicacionesZ.map((ubicacion: any) => (
                          <Select.Item key={ubicacion.id} value={ubicacion.id.toString()}>
                            {ubicacion.Nombre_Ubicacion}
                          </Select.Item>
                        ))
                      )}
                    </Select.Content>
                  </Select.Root>
                  {errors.listaUbicacioneszId && (
                    <Text size="1" color="red" mt="1">
                      {errors.listaUbicacioneszId.message}
                    </Text>
                  )}
                </Box>
              </Flex>

              <Box>
                <Text as="label" size="2" weight="medium" mb="2">
                  Módulo Z *
                </Text>
                <Select.Root
                  {...register("modulozId", { valueAsNumber: true })}
                  onValueChange={(value) => setValue("modulozId", parseInt(value))}
                  disabled={!selectedUbicacionZ}
                >
                  <Select.Trigger placeholder="Seleccione módulo" style={{ width: "100%" }} />
                  <Select.Content>
                    {loadingModulosZ ? (
                      <Select.Item value="0" disabled>
                        <Loader2 className="animate-spin" size={16} />
                        Cargando...
                      </Select.Item>
                    ) : modulosZ.length === 0 ? (
                      <Select.Item value="0" disabled>
                        No hay módulos disponibles
                      </Select.Item>
                    ) : (
                      modulosZ.map((modulo: any) => (
                        <Select.Item key={modulo.id} value={modulo.id.toString()}>
                          {modulo.Nombre}
                        </Select.Item>
                      ))
                    )}
                  </Select.Content>
                </Select.Root>
                {errors.modulozId && (
                  <Text size="1" color="red" mt="1">
                    {errors.modulozId.message}
                  </Text>
                )}
              </Box>

              <Box>
                <Flex align="center" gap="2" mb="2">
                  <Checkbox
                    checked={usarMapaZ}
                    onCheckedChange={(checked) => setUsarMapaZ(checked === true)}
                  />
                  <Text size="2" weight="medium">
                    Usar Mapa para Establecer Coordenadas
                  </Text>
                </Flex>

                {usarMapaZ && (
                  <Box mb="3">
                    <GoogleMapPicker onCoordinatesChange={handleMapCoordinatesZ} />
                  </Box>
                )}

                <Text as="label" size="2" weight="medium" mb="2">
                  Coordenadas Z *
                </Text>
                <TextField.Root
                  {...register("CoordenadasZ")}
                  placeholder="Ejemplo: 8.9138353 , -79.6087425"
                />
                {errors.CoordenadasZ && (
                  <Text size="1" color="red" mt="1">
                    {errors.CoordenadasZ.message}
                  </Text>
                )}
              </Box>

              <Box>
                <Flex align="center" gap="2">
                  <Checkbox
                    checked={usarInquilino}
                    onCheckedChange={(checked) => setUsarInquilino(checked === true)}
                  />
                  <Text size="2" weight="medium">
                    Es inquilino
                  </Text>
                </Flex>
                {inquilino && (
                  <Text size="1" color="gray" mt="1">
                    Inquilino actual: {inquilino}
                  </Text>
                )}
              </Box>

              <Box>
                <Flex align="center" gap="2">
                  <Checkbox {...register("isEspecial")} />
                  <Text size="2" weight="medium">
                    ¿Es una Viabilidad Especial?
                  </Text>
                </Flex>
              </Box>
            </Flex>
          </WizardStep>

          {/* PASO 4: Ruta y Conexión */}
          <WizardStep title="Ruta y Conexión" description="Seleccione la ruta y tipo de conexión">
            <Flex direction="column" gap="4">
              <Box>
                <Text as="label" size="2" weight="medium" mb="2">
                  Inquilino / Cliente Final
                </Text>
                <TextField.Root value={inquilino} disabled />
              </Box>

              <Box>
                <Text as="label" size="2" weight="medium" mb="2">
                  ¿Cuál será su Ruta? *
                </Text>
                <Select.Root
                  {...register("ID_RutaUbicacion", { valueAsNumber: true })}
                  onValueChange={(value) => setValue("ID_RutaUbicacion", parseInt(value))}
                  disabled={!selectedUbicacionZ}
                >
                  <Select.Trigger placeholder="Seleccione ruta" style={{ width: "100%" }} />
                  <Select.Content>
                    {loadingRutas ? (
                      <Select.Item value="0" disabled>
                        <Loader2 className="animate-spin" size={16} />
                        Cargando...
                      </Select.Item>
                    ) : rutas.length === 0 ? (
                      <Select.Item value="0" disabled>
                        No hay rutas para esa ubicación
                      </Select.Item>
                    ) : (
                      rutas.map((ruta: any) => (
                        <Select.Item key={ruta.id} value={ruta.id.toString()}>
                          {ruta.Nombre_Ruta}
                        </Select.Item>
                      ))
                    )}
                  </Select.Content>
                </Select.Root>
                {errors.ID_RutaUbicacion && (
                  <Text size="1" color="red" mt="1">
                    {errors.ID_RutaUbicacion.message}
                  </Text>
                )}
              </Box>

              <Box>
                <Text as="label" size="2" weight="medium" mb="2">
                  ¿Cuál será su Tipo de Conexión? *
                </Text>
                <Select.Root
                  {...register("ID_TipoConexion", { valueAsNumber: true })}
                  onValueChange={(value) => setValue("ID_TipoConexion", parseInt(value))}
                >
                  <Select.Trigger
                    placeholder="Seleccione tipo de conexión"
                    style={{ width: "100%" }}
                  />
                  <Select.Content>
                    {loadingTipoConexion ? (
                      <Select.Item value="0" disabled>
                        <Loader2 className="animate-spin" size={16} />
                        Cargando...
                      </Select.Item>
                    ) : tiposConexion.length === 0 ? (
                      <Select.Item value="0" disabled>
                        No hay tipos de conexión disponibles
                      </Select.Item>
                    ) : (
                      tiposConexion.map((tipo: any) => (
                        <Select.Item key={tipo.id} value={tipo.id.toString()}>
                          {tipo.Nombre}
                        </Select.Item>
                      ))
                    )}
                  </Select.Content>
                </Select.Root>
                {errors.ID_TipoConexion && (
                  <Text size="1" color="red" mt="1">
                    {errors.ID_TipoConexion.message}
                  </Text>
                )}
              </Box>

              <Flex gap="4">
                <Box style={{ flex: 1 }}>
                  <Text as="label" size="2" weight="medium" mb="2">
                    NRC *
                  </Text>
                  <TextField.Root {...register("NRC")} placeholder="Ingrese NRC" />
                  {errors.NRC && (
                    <Text size="1" color="red" mt="1">
                      {errors.NRC.message}
                    </Text>
                  )}
                </Box>

                <Box style={{ flex: 1 }}>
                  <Text as="label" size="2" weight="medium" mb="2">
                    MRC *
                  </Text>
                  <TextField.Root {...register("MRC")} placeholder="Ingrese MRC" />
                  {errors.MRC && (
                    <Text size="1" color="red" mt="1">
                      {errors.MRC.message}
                    </Text>
                  )}
                </Box>
              </Flex>
            </Flex>
          </WizardStep>
        </WizardSteps>

        <WizardActions
          onNext={handleNext}
          onSubmit={handleSubmit(onSubmit)}
          isNextDisabled={Object.keys(errors).length > 0}
          isSubmitDisabled={Object.keys(errors).length > 0}
          isLoading={createViabilidad.isPending}
        />
      </form>
    </>
  );
}
